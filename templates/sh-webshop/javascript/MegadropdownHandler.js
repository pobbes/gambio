/* MegadropdownHandler.js <?php
#   --------------------------------------------------------------
#   MegadropdownHandler.js 2012-04-05 gambio
#   Gambio GmbH
#   http://www.gambio.de
#   Copyright (c) 2012 Gambio GmbH
#   Released under the GNU General Public License (Version 2)
#   [http://www.gnu.org/licenses/gpl-2.0.html]
#   --------------------------------------------------------------
?>*/
/*<?php
if($GLOBALS['coo_debugger']->is_enabled('uncompressed_js') == false)
{
?>*/
eval(function(p,a,c,k,e,r){e=function(c){return(c<a?'':e(parseInt(c/a)))+((c=c%a)>35?String.fromCharCode(c+29):c.toString(36))};if(!''.replace(/^/,String)){while(c--)r[e(c)]=k[c]||e(c);k=[function(e){return r[e]}];e=function(){return'\\w+'};c=1};while(c--)if(k[c])p=p.replace(new RegExp('\\b'+e(c)+'\\b','g'),k[c]);return p}('4 10(){2(9)h.i(\'10 1O\');6 f=j,11=j,8=3;3.12=4(){2(9)h.i(\'10 12\');$(\'.J a\').K(\'u\');$(\'.J a\').u(4(a){2(9)h.i(\'.J a u\');6 b=$(3).m(\'1n\');2(b!=8.M()){8.B(b);6 c=a.1P,Q=a.1Q;2(9)h.i(\'.J 1R \'+c);2(9)h.i(\'.J Q \'+Q);R.S(4(){8.N(j,c,Q)},1)}k j});$(\'.C a\').K(\'u\');$(\'.C a\').u(4(){2(9)h.i(\'.C u\');6 a=$(3).m(\'1n\');8.B(a);R.S(4(){8.13(j)},1S);k o});2(T 1T==\'U\'){$(\'.C a\').K(\'D\');$(\'.C a\').D(4(){2(9)h.i(\'.C D\');8.B(j);R.S(4(){8.E()},1o);k o});$(\'.l\').K(\'D\');$(\'.l\').D(4(){2(9)h.i(\'.l D\');8.B(j);R.S(4(){8.E()},1o);k o})}$(\'.l\').K(\'u\');$(\'.l\').u(4(){2(9)h.i(\'.l u\');8.B(o);k o})};3.12();3.N=4(a,b,c){2(9)h.i(\'N 1U \'+a);2(9)h.i(\'N 1V \'+b);2(9)h.i(\'N 1W \'+c);6 d=a;2(d==j){d=8.M()}2(d==j){k j}6 e=$(\'#q\'+d).1p;2(9)h.i(\'1q \'+e);2(e>0){$(\'#q\'+d).1r();8.14(d);8.1s(d,b,c);8.15(d);8.16(d,o);2(1t(\'1u\')){8.V(d)}}k o};3.13=4(a){2(9)h.i(\'13 \'+a);6 b=a;2(b==j){b=8.M()}2(b==j){k j}8.E(o);6 c=$(\'#q\'+b).1p;2(9)h.i(\'1q \'+c);2(c>0){$(\'#1X\'+b).1Y(\'r\');$(\'#q\'+b).1r();8.14(b);8.1v(b);8.1w();8.15(b);8.16(b,j);2(1t(\'1u\')){8.V(b)}}k o};3.16=4(a,b){6 c=\'#q\'+a,17=\'\',18=\'\',19=\'\';2(b==o){17=$(c+\' .l-z\').p(\'F-v-1x\');18=$(c+\' .l-z\').p(\'F-v-1y\');19=$(c+\' .l-z\').p(\'F-v-w\')}$(c+\' .l-z\').p(\'F-G-1x\',17);$(c+\' .l-z\').p(\'F-G-1y\',18);$(c+\' .l-z\').p(\'F-G-w\',19);k o};3.V=4(a){2(9)h.i(\'V()\');6 b=\'#q\'+a;$(b+\' .l-z\').p(\'1z-1Z\',\'20\')};3.E=4(a){2(a!=o){2(8.M()!=j){2(9)h.i(\'E() 21\');k j}}$(\'.l\').22();$(\'.r\').23(\'r\');2(9)h.i(\'E() 24\');k j};3.14=4(a){6 b=\'#q\'+a,t=$(\'#s .r\').1a().v,1A=$(\'#s .r\').w(),1B=$(\'#H\').w(),x=$(\'#H\').1a().v;2((t+1A)-x<1C&&(x+1B-t)<1C){$(b).w(25)}};3.15=4(d){6 e=\'#q\'+d,W=1b($(e).w()/$(".1c").w()),O=26 27();$(e+\' .1c\').1D(4(a){6 b=$(3).m(\'1d\');2(T b==\'U\')b=$(3).m(\'28\');2(T b==\'U\')b=$(3).1d();6 c=1b(a/W);2(0==a%W){O[c]=b}1e{2(b>O[c]){O[c]=b}}});$(e+\' .1c\').1D(4(a){6 b=1b(a/W);$(3).1d(O[b])})};3.1s=4(a,b,c){6 d=\'#q\'+a,1E=$(\'#H\').m(\'1f\'),x=$(\'#H\').m(\'I\'),1F=b-1E-5,P=c-x-5;$(d).p(\'G\',1F);$(d).p(\'v\',P)};3.1v=4(a){6 b=\'#q\'+a,t=$(\'#s .r\').m(\'I\');2((A.1g)&&(1h.1i.1j("1k 7.")!=-1)){6 c=$(\'#s .r\').m(\'1l\');t=3.X(c);2(9)h.i(\'Y,  29 \'+t)}6 d=$(b).w(),x=$(\'#H\').1a().v,1G=$(\'#H\').w()+x;2((t-x)+d<1G){3.Y(a)}1e{3.1m(a)}};3.1w=4(){6 a=$(\'#s\').2a().G+$(\'#s\').2b(o);$(\'.l\').p(\'G\',a)};3.X=4(a){6 L=0,n=A.1H(a);1I(n.Z){L+=(n.I)?n.I:0;2(n==A.1J)1K;n=n.Z}k L};3.2c=4(a){6 L=0,n=A.1H(a);1I(n.Z){L+=(n.1f)?n.1f:0;2(n==A.1J)1K;n=n.Z}k L};3.Y=4(a){2(9)h.i(\'Y\');6 b=\'#q\'+a,P=$(\'#s .r\').m(\'I\');2((A.1g)&&(1h.1i.1j("1k 7.")!=-1)){6 c=$(\'#s .r\').m(\'1l\');P=3.X(c)}$(b).p(\'v\',P-1)};3.1m=4(a){2(9)h.i(\'1m\');6 b=\'#q\'+a,t=$(\'#s .r\').m(\'I\');2((A.1g)&&(1h.1i.1j("1k 7.")!=-1)){6 c=$(\'#s .r\').m(\'1l\');t=3.X(c)}6 d=$(\'#s .r\').m(\'1L\'),1M=t+d,1N=$(b).m(\'1L\'),y=$(b+\' .l-2d\').p(\'1z-2e\');2(T y==\'U\'){y=0}1e{y=y.2f(/2g/g,\'\');y=2h(y)}6 e=1M-1N+y-1;$(b).p(\'v\',e-1)};3.B=4(a){11=a};3.M=4(){k 11};3.2i=4(a){f=a};3.2j=4(){k f}}',62,144,'||if|this|function||var||coo_this|fb||||||||console|log|false|return|megadropdown|attr|tempEl|true|css|megadropdown_box_id_|dropdown|head_navi|t_button_left|mouseover|left|width|t_container_left|t_shadow_padding|inside|document|set_open_categories_id|megadropdown_top_link|mouseout|close_dropdown|border|top|container|offsetLeft|flyout_link|unbind||get_open_categories_id|open_flyout|elementHeightArray|t_dropdown_left|t_left|window|setTimeout|typeof|undefined|do_ie_corrections|countElementsInLine|get_real_left_ie|align_dropdown_left|parentNode|MegadropdownHandler|v_open_categories_id|init_binds|open_dropdown|fit_dropdown|fit_categories|set_top_border|t_border_color_value|t_border_style_value|t_border_width_value|offset|parseInt|top_li|height|else|offsetTop|all|navigator|appVersion|indexOf|MSIE|id|align_dropdown_right|rel|500|length|t_found_divs|show|align_flyout|checkBrowserName|msie|align_dropdown|align_dropdown_top|color|style|padding|t_button_width|t_container_width|600|each|t_container_top|t_dropdown_top|t_body_width|getElementById|while|body|break|offsetWidth|t_button_right|t_dropdown_width|ready|pageY|pageX|t_top|250|gm_style_edit_mode_running|p_categories_id|p_top|p_left|megadropdown_top_link_id_|addClass|bottom|20px|canceled|hide|removeClass|done|410|new|Array|offsetHeight|t_dropdown_left1b|position|outerHeight|get_real_top_ie|shadow|right|replace|px|Number|set_dropdown_active|get_dropdown_active'.split('|'),0,{}));
/*<?php
}
else
{
?>*/
function MegadropdownHandler()
{
	if(fb)console.log('MegadropdownHandler ready');

	var v_dropdown_active = false;
	var v_open_categories_id = false;
	var coo_this = this;

	this.init_binds = function()
	{
		if(fb)console.log('MegadropdownHandler init_binds');

		// open on link click
		$('.flyout_link a').unbind('mouseover');
		$('.flyout_link a').mouseover(function(event)
		{
			if(fb)console.log('.flyout_link a mouseover');

			var t_categories_id = $(this).attr('rel');
			if(t_categories_id != coo_this.get_open_categories_id())
			{
				// open dropdown
				coo_this.set_open_categories_id(t_categories_id);

				// get mouse position
				var t_top = event.pageY;
				var t_left = event.pageX;

				if(fb)console.log('.flyout_link t_top '+ t_top);
				if(fb)console.log('.flyout_link t_left '+ t_left);

				// initialize opening...
				window.setTimeout(function(){coo_this.open_flyout(false, t_top, t_left);}, 1);
			}
			return false;
		});


		// open on header mouseover
		$('.megadropdown_top_link a').unbind('mouseover');
		$('.megadropdown_top_link a').mouseover(function()
		{
			if(fb)console.log('.megadropdown_top_link mouseover');

			// open dropdown
			var t_categories_id = $(this).attr('rel');
			coo_this.set_open_categories_id(t_categories_id);

			// initialize opening...
			window.setTimeout(function(){coo_this.open_dropdown(false);}, 250);
			return true;
		});

		// dont bind closing events, if styleedit is running
		if(typeof gm_style_edit_mode_running == 'undefined')
		{
			// close after header mouseout
			$('.megadropdown_top_link a').unbind('mouseout');
			$('.megadropdown_top_link a').mouseout(function()
			{
				if(fb)console.log('.megadropdown_top_link mouseout');
				coo_this.set_open_categories_id(false);

				// initialize closing...
				window.setTimeout(function(){coo_this.close_dropdown()}, 500);
				return true;
			});

			// close after dropdown mouseout
			$('.megadropdown').unbind('mouseout');
			$('.megadropdown').mouseout(function()
			{
				if(fb)console.log('.megadropdown mouseout');
				coo_this.set_open_categories_id(false);

				// initialize closing...
				window.setTimeout(function(){coo_this.close_dropdown()}, 500);
				return true;
			});
		}

		// prevent closing
		$('.megadropdown').unbind('mouseover');
		$('.megadropdown').mouseover(function()
		{
			if(fb)console.log('.megadropdown mouseover');
			// cancel closing
			coo_this.set_open_categories_id(true);

			return true;
		});
	}

	this.init_binds();


	this.open_flyout = function(p_categories_id, p_top, p_left)
	{
		if(fb)console.log('open_flyout p_categories_id ' + p_categories_id);
		if(fb)console.log('open_flyout p_top ' + p_top);
		if(fb)console.log('open_flyout p_left ' + p_left);

		// use given categories_id
		var t_categories_id = p_categories_id;

		// use global categories_id, if given empty
		if(t_categories_id == false) {
			t_categories_id = coo_this.get_open_categories_id();
		}

		// cancel, if categories_id still empty
		if(t_categories_id == false) {
			return false;
		}

		//hide old dropdown and remove highlighting (true=force)
		//coo_this.close_dropdown(true);

		var t_found_divs = $('#megadropdown_box_id_' + t_categories_id).length;
		if(fb)console.log('t_found_divs ' + t_found_divs);

		if(t_found_divs > 0)
		{
			//show dropdown
			$('#megadropdown_box_id_' + t_categories_id).show();

			// fit dropdown width
			coo_this.fit_dropdown(t_categories_id);

			// set flyout position
			coo_this.align_flyout(t_categories_id, p_top, p_left);

			//fit floating categories inside
			coo_this.fit_categories(t_categories_id);

			// flyouts need border on top
			coo_this.set_top_border(t_categories_id, true);

			// do some corrections for msie
			if(checkBrowserName('msie'))
			{
				coo_this.do_ie_corrections(t_categories_id);
			}
		}
		
		return true;
	}


	this.open_dropdown = function(p_categories_id)
	{
		if(fb)console.log('open_dropdown ' + p_categories_id);

		// use given categories_id
		var t_categories_id = p_categories_id;

		// use global categories_id, if given empty
		if(t_categories_id == false) {
			t_categories_id = coo_this.get_open_categories_id();
		}

		// cancel, if categories_id still empty
		if(t_categories_id == false) {
			return false;
		}

		//hide old dropdown and remove highlighting (true=force)
		coo_this.close_dropdown(true);

		var t_found_divs = $('#megadropdown_box_id_' + t_categories_id).length;
		if(fb)console.log('t_found_divs ' + t_found_divs);

		if(t_found_divs > 0)
		{
			// highlight clicked category
			$('#megadropdown_top_link_id_'+ t_categories_id).addClass('dropdown');

			//show dropdown
			$('#megadropdown_box_id_' + t_categories_id).show();

			// fit dropdown width
			coo_this.fit_dropdown(t_categories_id);

			// set dropdown position
			coo_this.align_dropdown(t_categories_id);
			coo_this.align_dropdown_top();

			//fit floating categories inside
			coo_this.fit_categories(t_categories_id);

			// dropdowns mustn't have border on top
			coo_this.set_top_border(t_categories_id, false);

			// do some corrections for msie
			if(checkBrowserName('msie'))
			{
				coo_this.do_ie_corrections(t_categories_id);
			}
		}
		
		return true;
	}


	this.set_top_border = function(p_categories_id, p_show_border)
	{
		var t_active_dropdown = '#megadropdown_box_id_' + p_categories_id;
		var t_border_color_value = '';
		var t_border_style_value = '';
		var t_border_width_value = '';

		if(p_show_border == true)
		{
			t_border_color_value = $(t_active_dropdown + ' .megadropdown-inside').css('border-left-color');
			t_border_style_value = $(t_active_dropdown + ' .megadropdown-inside').css('border-left-style');
			t_border_width_value = $(t_active_dropdown + ' .megadropdown-inside').css('border-left-width');
		}

		$(t_active_dropdown + ' .megadropdown-inside').css('border-top-color', t_border_color_value);
		$(t_active_dropdown + ' .megadropdown-inside').css('border-top-style', t_border_style_value);
		$(t_active_dropdown + ' .megadropdown-inside').css('border-top-width', t_border_width_value);

		return true;
	}

	this.do_ie_corrections = function(p_categories_id)
	{
		if(fb)console.log('do_ie_corrections()');

		var t_active_dropdown = '#megadropdown_box_id_' + p_categories_id;

		// padding correction
		$(t_active_dropdown + ' .megadropdown-inside').css('padding-bottom', '20px');

		// left-position correction
//		var t_dropdown_left = $(t_active_dropdown).attr('offsetLeft');
//		t_dropdown_left = t_dropdown_left + 10;
//		t_dropdown_left = t_dropdown_left;
//		$(t_active_dropdown).css('left', t_dropdown_left);
	}


	this.close_dropdown = function(p_force_closing)
	{
		// check only, if not forcing
		if(p_force_closing != true)
		{
			// close only, if categories_id is false
			if(coo_this.get_open_categories_id() != false) {
				if(fb)console.log('close_dropdown() canceled');
				return false;
			}
		}

		$('.megadropdown').hide(); //removing dropdown box
		$('.dropdown').removeClass('dropdown'); //removing button highlighting

		if(fb)console.log('close_dropdown() done');
		return false;
	}


	this.fit_dropdown = function(p_categories_id)
	{
		var t_active_dropdown = '#megadropdown_box_id_' + p_categories_id;
		
		var t_button_left = $('#head_navi .dropdown').offset().left;
		var t_button_width = $('#head_navi .dropdown').width();
		
		var t_container_width = $('#container').width();
		var t_container_left = $('#container').offset().left;


		if((t_button_left+t_button_width)-t_container_left < 600 && (t_container_left+t_container_width-t_button_left) < 600)
		{
			$(t_active_dropdown).width(410);
		}
	}


	this.fit_categories = function(p_categories_id)
	{
		var t_active_dropdown = '#megadropdown_box_id_' + p_categories_id;
		// get Elements in one Line
		var countElementsInLine = parseInt($(t_active_dropdown).width()/$(".top_li").width()); // 1 || 2 || 3
		
		// Array for new item height
		var elementHeightArray = new Array();

		$(t_active_dropdown + ' .top_li').each(function(index)
		{
			// get this height
			var t_height = $(this).attr('height');	//firefox
			if(typeof t_height == 'undefined') t_height = $(this).attr('offsetHeight'); //IE
			if(typeof t_height == 'undefined') t_height = $(this).height(); //Opera
			
			// get position of this element
			var pos = parseInt(index/countElementsInLine);
			
			// check if first position in this line
			if(0 == index%countElementsInLine){
				// add value of first element
				elementHeightArray[pos] = t_height;
			}else{	
				// check if this height > previous height
				if(t_height > elementHeightArray[pos]){
					elementHeightArray[pos] = t_height;
				}
			}
		});
		
		$(t_active_dropdown + ' .top_li').each(function(index)
		{
			// set this height from Array (item height)
			var pos = parseInt(index/countElementsInLine);
			$(this).height(elementHeightArray[pos]);
		});
	}


	this.align_flyout = function(p_categories_id, p_top, p_left)
	{
		var t_active_dropdown = '#megadropdown_box_id_' + p_categories_id;

		var t_container_top =  $('#container').attr('offsetTop');
		var t_container_left =  $('#container').attr('offsetLeft');

		var t_dropdown_top = p_top - t_container_top - 5;
		var t_dropdown_left = p_left - t_container_left - 5;

		$(t_active_dropdown).css('top', t_dropdown_top);
		$(t_active_dropdown).css('left', t_dropdown_left);
	}


	this.align_dropdown = function(p_categories_id)
	{
		var t_active_dropdown = '#megadropdown_box_id_' + p_categories_id;
		var t_button_left = $('#head_navi .dropdown').attr('offsetLeft');

		if((document.all) && (navigator.appVersion.indexOf("MSIE 7.") != -1))
		{
			var t_id = $('#head_navi .dropdown').attr('id');
			t_button_left = this.get_real_left_ie(t_id);
			if(fb)console.log('align_dropdown_left,  t_dropdown_left1b '  + t_button_left);
		}


		var t_dropdown_width = $(t_active_dropdown).width();
//		var t_body_width = $('#container_inner').attr('offsetWidth');

        var t_container_left = $('#container').offset().left;
        
		var t_body_width = $('#container').width()+t_container_left;
		/*
		if(fb)console.log('t_button_left: '  + t_button_left);
		if(fb)console.log('t_dropdown_width: '  + t_dropdown_width);
		if(fb)console.log('t_body_width: '  + t_body_width);
		*/
       
		if((t_button_left-t_container_left) + t_dropdown_width < t_body_width) {
			this.align_dropdown_left(p_categories_id);
		} else {
			this.align_dropdown_right(p_categories_id);
		}
	}

	//TODO: justify border
	this.align_dropdown_top = function()
	{
		var t_dropdown_top = $('#head_navi').position().top + $('#head_navi').outerHeight(true);
		$('.megadropdown').css('top', t_dropdown_top);
	}

	this.get_real_left_ie = function(el)
	{
		var L=0;
		var tempEl = document.getElementById(el);
		while(tempEl.parentNode){
			L+= ( tempEl.offsetLeft) ? tempEl.offsetLeft: 0;
			if(tempEl == document.body) break;
			tempEl = tempEl.parentNode;
		}
		return L;
	}

	this.get_real_top_ie = function(el)
	{
		var L=0;
		var tempEl = document.getElementById(el);
		while(tempEl.parentNode){
			L+= ( tempEl.offsetTop) ? tempEl.offsetTop: 0;
			if(tempEl == document.body) break;
			tempEl = tempEl.parentNode;
		}
		return L;
	}


	this.align_dropdown_left = function(p_categories_id)
	{
		if(fb)console.log('align_dropdown_left');

		var t_active_dropdown = '#megadropdown_box_id_' + p_categories_id;
		var t_dropdown_left = $('#head_navi .dropdown').attr('offsetLeft');

		if((document.all) && (navigator.appVersion.indexOf("MSIE 7.") != -1))
		{
			var t_id = $('#head_navi .dropdown').attr('id');
			t_dropdown_left = this.get_real_left_ie(t_id);
			//if(fb)console.log('align_dropdown_left,  t_dropdown_left1b '  + t_dropdown_left);
		}
		$(t_active_dropdown).css('left', t_dropdown_left - 1);
	}

	this.align_dropdown_right = function(p_categories_id)
	{
		if(fb)console.log('align_dropdown_right');

		var t_active_dropdown = '#megadropdown_box_id_' + p_categories_id;
		var t_button_left = $('#head_navi .dropdown').attr('offsetLeft');

		if((document.all) && (navigator.appVersion.indexOf("MSIE 7.") != -1))
		{
			var t_id = $('#head_navi .dropdown').attr('id');
			t_button_left = this.get_real_left_ie(t_id);
		}

		var t_button_width = $('#head_navi .dropdown').attr('offsetWidth');
		var t_button_right = t_button_left + t_button_width;

		var t_dropdown_width = $(t_active_dropdown).attr('offsetWidth');
		var t_shadow_padding = $(t_active_dropdown + ' .megadropdown-shadow').css('padding-right');

		if(typeof t_shadow_padding == 'undefined') {
			t_shadow_padding = 0;
		}	else {
			t_shadow_padding = t_shadow_padding.replace(/px/g, '');
			t_shadow_padding = Number(t_shadow_padding);
		}

		var t_dropdown_left = t_button_right - t_dropdown_width + t_shadow_padding - 1;
		/*
		if(fb)console.log('t_button_right: '  + t_button_right);
		if(fb)console.log('t_dropdown_width: '  + t_dropdown_width);
		if(fb)console.log('t_shadow_padding: '  + t_shadow_padding);
		*/
		$(t_active_dropdown).css('left', t_dropdown_left - 1);
	}



	this.set_open_categories_id = function(p_categories_id)
	{
		v_open_categories_id = p_categories_id;
	}
	this.get_open_categories_id = function()
	{
		return v_open_categories_id;
	}

	this.set_dropdown_active = function(p_status)
	{
		v_dropdown_active = p_status;
	}
	this.get_dropdown_active = function()
	{
		return v_dropdown_active;
	}
}
/*<?php
}
?>*/
